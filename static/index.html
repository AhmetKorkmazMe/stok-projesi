<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StokÃ§u - AkÄ±llÄ± Entegrasyon Paneli</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- MODERN & CLEAN UI --- */
        :root { 
            --primary: #0F766E; 
            --primary-dark: #0D6E66; 
            --bg-light: #F8FAFC; 
            --text-dark: #1E293B; 
            --border-color: #E2E8F0; 
            --accent-blue: #3B82F6;
        }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-dark); margin: 0; line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; font-size: 15px; }
        * { box-sizing: border-box; }
        
        /* HEADER */
        .site-header { background: #fff; border-bottom: 1px solid var(--border-color); padding: 1rem 0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
        .wrap { max-width: 1280px; margin: 0 auto; padding: 0 30px; }
        .branding-link { text-decoration: none; color: inherit; display: flex; align-items: center; gap: 15px; }
        /* Logo BÃ¼yÃ¼tÃ¼ldÃ¼ */
        .site-logo { height: 90px; width: auto; } 
        .branding-text .brand { margin: 0; font-size: 1.8rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
        .branding-text .subtitle { margin: 0; font-size: 0.95rem; color: #64748B; font-weight: 500; }

        /* WIZARD CONTAINER */
        .container { max-width: 1280px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); overflow: hidden; display: flex; border: 1px solid var(--border-color); min-height: 700px; }
        
        /* NAV SIDEBAR */
        #wizard-nav { width: 280px; background: #F1F5F9; border-right: 1px solid var(--border-color); padding: 30px 0; display: flex; flex-direction: column; flex-shrink: 0; }
        #wizard-nav button { background: none; border: none; text-align: left; padding: 18px 30px; width: 100%; font-weight: 600; color: #64748B; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; font-size: 0.95rem; display: flex; align-items: center; gap: 10px; }
        #wizard-nav button.active { background: #fff; color: var(--primary); border-left-color: var(--primary); font-weight: 700; box-shadow: 0 4px 10px -5px rgba(0,0,0,0.05); }
        #wizard-nav button:disabled { opacity: 0.6; cursor: not-allowed; }
        .step-num { display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: #CBD5E1; color: #fff; border-radius: 50%; font-size: 0.8rem; font-weight: 700; }
        #wizard-nav button.active .step-num { background: var(--primary); }

        /* CONTENT AREA */
        #wizard-container { flex: 1; padding: 50px 60px; overflow-y: auto; }
        .wizard-step { display: none; animation: fadeIn 0.3s ease-out; }
        #step-0 { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        h2 { margin-top: 0; color: var(--text-dark); border-bottom: 1px solid #E2E8F0; padding-bottom: 20px; margin-bottom: 30px; font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        h3 { font-size: 1.1rem; margin-bottom: 15px; color: var(--primary); font-weight: 700; }

        /* FORMS */
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 0.9rem; }
        .form-hint { font-size: 0.8rem; color: #64748B; margin-top: 5px; display: block; line-height: 1.4; }
        .text-muted-small { display: block; font-size: 0.8rem; color: #64748B; font-weight: normal; margin-top: 4px; line-height: 1.3; }
        
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 12px 15px; border: 1px solid #CBD5E1; border-radius: 8px; font-size: 0.95rem; transition: all 0.2s; background: #fff; color: #1E293B; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1); }
        
        /* GeliÅŸtirilmiÅŸ Radio Group */
        .radio-group { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; padding: 15px; border: 1px solid #E2E8F0; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: #fff; }
        .radio-group:hover { border-color: #94A3B8; background: #F8FAFC; }
        .radio-group label { font-size: 0.95rem; margin: 0; font-weight: 600; cursor: pointer; color: #1E293B; }
        .radio-group input { width: 18px; height: 18px; accent-color: var(--primary); margin-right: 8px; cursor: pointer; margin-top: 3px; }
        .radio-content { flex: 1; }

        .input-group { display: flex; gap: 20px; margin-bottom: 25px; }
        
        hr { border: none; border-top: 1px solid #E2E8F0; margin: 35px 0; }

        /* ALERTS & INFO */
        .info-box { background-color: #EFF6FF; border: 1px solid #DBEAFE; padding: 20px; border-radius: 8px; margin-bottom: 30px; color: #1E40AF; font-size: 0.9rem; display: flex; gap: 15px; align-items: flex-start; line-height: 1.5; }
        .info-box span { font-size: 1.4rem; }
        /* Sorumluluk Reddi Stili */
        .disclaimer-box { background-color: #FEF2F2; border: 1px solid #F87171; padding: 20px; border-radius: 8px; margin-bottom: 25px; color: #7F1D1D; font-size: 0.9rem; display: flex; gap: 15px; align-items: flex-start; }
        .disclaimer-box strong { display: block; margin-bottom: 5px; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* FORMULA VISUALIZATION */
        .formula-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; padding: 20px; background: #F8FAFC; border: 1px dashed #CBD5E1; border-radius: 12px; margin-bottom: 25px; font-family: monospace; font-size: 1.1rem; color: #334155; }
        .formula-tag { padding: 6px 12px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .ft-cost { background: #DBEAFE; color: #1E40AF; }
        .ft-mult { background: #DCFCE7; color: #166534; }
        .ft-add { background: #FEF3C7; color: #92400E; }
        .ft-res { background: #1E293B; color: #fff; }
        
        /* FLOW CONNECTOR */
        .step-connector { text-align: center; margin: 15px 0; position: relative; color: #94A3B8; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .step-connector::before, .step-connector::after { content: ''; height: 1px; background: #E2E8F0; flex: 1; }

        /* BUTTONS */
        .primary-btn { background-color: var(--primary); color: #fff; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(15, 118, 110, 0.2); }
        .primary-btn:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 6px rgba(15, 118, 110, 0.3); }
        .secondary-btn { background-color: #fff; color: #475569; border: 1px solid #CBD5E1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .secondary-btn:hover:not(:disabled) { background-color: #F1F5F9; color: #1E293B; border-color: #94A3B8; }
        .danger-btn { background-color: #FEF2F2; color: #EF4444; border: 1px solid #FECACA; padding: 0 15px; font-weight: bold; }
        .danger-btn:hover { background-color: #FEE2E2; border-color: #EF4444; }

        /* DROPZONE */
        .dropzone-like { border: 2px dashed #CBD5E1; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; background: #F8FAFC; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 140px; }
        .dropzone-like:hover { border-color: var(--primary); background: #F0FDFA; transform: scale(1.01); }
        .dz-icon { font-size: 2.5rem; color: #94A3B8; margin-bottom: 15px; transition: color 0.2s; }
        .dropzone-like:hover .dz-icon { color: var(--primary); }
        .dz-like-text { color: #475569; font-weight: 600; font-size: 1rem; }
        .dz-subtext { font-size: 0.8rem; color: #94A3B8; margin-top: 5px; }

        /* NLP & SIMULATION */
        .nlp-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        .guide-panel { background: #fff; border: 1px solid #E2E8F0; border-radius: 8px; overflow: hidden; height: fit-content; max-height: 500px; display: flex; flex-direction: column; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
        .guide-header { background: #F8FAFC; padding: 15px; font-weight: 700; color: #475569; font-size: 0.9rem; border-bottom: 1px solid #E2E8F0; }
        .guide-content { overflow-y: auto; flex: 1; }
        .guide-item { padding: 12px 15px; border-bottom: 1px solid #F1F5F9; cursor: pointer; transition: background 0.1s; font-size: 0.85rem; color: var(--text-dark); }
        .guide-item:hover { background: #F0FDFA; padding-left: 20px; }
        .guide-item strong { color: var(--primary); }
        .guide-desc { font-size: 0.75rem; color: #64748B; display: block; margin-top: 4px; font-weight: normal; }
        
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-bottom: 2px; }
        .bg-red { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; }
        .bg-green { background: #F0FDF4; color: #166534; border: 1px solid #DCFCE7; }
        .bg-blue { background: #EFF6FF; color: #1E40AF; border: 1px solid #DBEAFE; }

        .sim-container { margin-top: 20px; padding: 20px; background: #fff; border: 1px solid #E2E8F0; border-radius: 8px; }
        .sim-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 15px; }
        .sim-table th { background: #F8FAFC; text-align: left; padding: 10px; border-bottom: 1px solid #CBD5E1; color: #475569; font-weight: 700; }
        .sim-table td { padding: 10px; border-bottom: 1px solid #F1F5F9; color: #334155; }

        /* HOW IT WORKS SECTION */
        .info-section { max-width: 1000px; margin: 0 auto 80px auto; padding: 0 30px; }
        .accordion-btn { background-color: #fff; color: #1E293B; cursor: pointer; padding: 25px 30px; width: 100%; border: 1px solid #E2E8F0; border-radius: 12px; text-align: left; outline: none; font-size: 1.1rem; font-weight: 700; transition: 0.3s; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .accordion-btn:hover { border-color: #CBD5E1; }
        .accordion-btn.active { background-color: #F0FDFA; border-color: var(--primary); border-radius: 12px 12px 0 0; margin-bottom: 0; color: var(--primary); }
        .panel { padding: 0 40px; background-color: #fff; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; border-radius: 0 0 12px 12px; margin-bottom: 15px; border: 1px solid var(--primary); border-top: none; color: #475569; font-size: 0.95rem; line-height: 1.7; }
        .panel.show { padding: 30px 40px; }

        /* FOOTER */
        .site-footer { background-color: #1E293B; color: #94A3B8; padding: 60px 0; margin-top: auto; border-top: 1px solid #334155; }
        .footer-content { max-width: 1280px; margin: 0 auto; padding: 0 30px; display: flex; justify-content: space-between; align-items: center; }
        .footer-links a { color: #CBD5E1; text-decoration: none; margin-left: 25px; transition: color 0.2s; font-size: 0.9rem; }
        .footer-links a:hover { color: #fff; }

        /* MODAL & UTILS */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 40px; border-radius: 16px; width: 90%; max-width: 600px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 90vh; overflow-y: auto; }
        .progress-container { margin-top: 30px; display: none; }
        .progress-bar-bg { background-color: #E2E8F0; border-radius: 10px; height: 24px; overflow: hidden; position: relative; }
        .progress-bar-fill { background-color: var(--primary); height: 100%; width: 0%; transition: width 0.5s ease; }
        .progress-text { text-align: center; font-weight: 600; color: var(--primary); margin-top: 10px; font-size: 0.9rem; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .error-message { color: #B91C1C; background: #FEF2F2; border: 1px solid #FECACA; padding: 15px; border-radius: 8px; margin-top: 20px; display: none; font-size: 0.9rem; }
        .success-message { color: #065F46; background: #ECFDF5; border: 1px solid #A7F3D0; padding: 25px; border-radius: 12px; margin-top: 30px; text-align: center; font-weight: 700; font-size: 1.1rem; }
        #mapping-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        @media (max-width: 900px) {
            .container { flex-direction: column; height: auto; min-height: auto; margin: 20px auto; box-shadow: none; border: none; background: transparent; }
            #wizard-nav { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); flex-direction: row; overflow-x: auto; padding: 0; background: #fff; border-radius: 12px 12px 0 0; }
            #wizard-nav button { padding: 15px 20px; white-space: nowrap; border-left: none; border-bottom: 4px solid transparent; width: auto; flex: 1; text-align: center; justify-content: center; }
            #wizard-nav button.active { border-left: none; border-bottom-color: var(--primary); background: #F0FDFA; }
            #wizard-container { padding: 30px 20px; background: #fff; border-radius: 0 0 12px 12px; border: 1px solid var(--border-color); border-top: none; }
            .nlp-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="page-index">

    <header class="site-header">
        <div class="wrap">
            <a href="/" class="branding-link">
                <img src="img/logo.png" alt="StokÃ§u Logo" class="site-logo">
                <div class="branding-text">
                    <h1 class="brand">StokÃ§u</h1>
                    <p class="subtitle">Entegrasyon ve Fiyat Motoru</p>
                </div>
            </a>
        </div>
    </header>

    <div id="wizard-section" class="container">
        <nav id="wizard-nav">
            <button id="btn-step-0" class="active"><span class="step-num">1</span> Ayarlar</button>
            <button id="btn-step-1" disabled><span class="step-num">2</span> Ä°Ã§ Stok (Master)</button>
            <button id="btn-step-2" disabled><span class="step-num">3</span> TedarikÃ§iler</button>
            <button id="btn-step-3" disabled><span class="step-num">4</span> Fiyat Motoru</button>
            <button id="btn-step-4" disabled><span class="step-num">5</span> Rapor</button>
        </nav>

        <div id="wizard-container">
            <div id="step-0" class="wizard-step">
                <h2>Sistemi YapÄ±landÄ±r</h2>
                
                <div class="info-box">
                    <span>ğŸ’¡</span>
                    <div>
                        <strong>HoÅŸ Geldiniz!</strong> StokÃ§u, daÄŸÄ±nÄ±k stok verilerinizi birleÅŸtirip pazar yerlerine (Trendyol, HB) hazÄ±r hale getirir.
                        <br><span style="font-size:0.85rem; color:#64748B;">
                        ğŸ”’ <strong>Veri GizliliÄŸi:</strong> YÃ¼klediÄŸiniz dosyalar ve oluÅŸturulan raporlar, iÅŸlem bittiÄŸinde veya oturum kapandÄ±ÄŸÄ±nda <strong>veri gizliliÄŸi sebebiyle otomatik olarak silinir.</strong>
                        </span>
                    </div>
                </div>

                <div class="form-group">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <label style="margin:0">GÃ¼ncel DÃ¶viz KurlarÄ±</label>
                        <button id="refresh-rates-btn" class="primary-btn secondary-btn" style="padding:6px 14px; font-size:0.8rem;">TCMB'den Yenile</button>
                    </div>
                    <span class="form-hint">Sistem, fiyat hesaplamalarÄ±nda buradaki kurlarÄ± baz alÄ±r.</span>
                    <div id="rates-loader" class="loader" style="margin-top:10px;"></div>
                    <div id="exchange-rates-display" style="margin-top:10px;">
                        <p style="background:#F8FAFC; padding:12px 15px; border-radius:8px; border:1px solid #E2E8F0; color:#64748B;">Veri bekleniyor...</p>
                    </div>
                </div>

                <div class="form-group" style="margin-top:30px;">
                    <label>Sahipsiz (EÅŸleÅŸmeyen) ÃœrÃ¼nler Ne Olsun?</label>
                    <span class="form-hint">Ä°Ã§ stoÄŸunuzda veya tedarikÃ§ide bulunamayan pazar yeri Ã¼rÃ¼nleri iÃ§in aksiyon seÃ§in.</span>
                    <select id="orphan-strategy-select" style="margin-top:8px;">
                        <option value="zero">StoÄŸu SÄ±fÄ±rla (GÃ¼venli Mod - Ã–nerilen)</option>
                        <option value="keep">Mevcut StoÄŸu Koru (Riskli)</option>
                    </select>
                </div>

                <hr>
                <h3>âš™ï¸ Åablon YÃ¶netimi</h3>
                <span class="form-hint" style="margin-bottom:15px;">Daha Ã¶nce kaydettiÄŸiniz sÃ¼tun eÅŸleÅŸtirmelerini (JSON) geri yÃ¼kleyin.</span>
                <div class="form-group" style="display:flex; gap:15px;">
                    <div style="position:relative; display:inline-block;">
                        <button class="primary-btn secondary-btn" onclick="document.getElementById('template-import-file').click()">ğŸ“‚ Yedek DosyasÄ± SeÃ§ (.json)</button>
                        <input type="file" id="template-import-file" accept=".json" style="display:none;" onchange="handleTemplateImport(event)">
                    </div>
                </div>
                <div class="form-group">
                    <label>KayÄ±tlÄ± Åablonlar:</label>
                    <div id="template-management-list" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                        <p style="color:#64748B; font-size:0.9rem; background:#F1F5F9; padding:15px; border-radius:8px; border:1px dashed #CBD5E1; width:100%;">
                            â„¹ï¸ <strong>Ä°lk kez mi kullanÄ±yorsunuz?</strong><br>
                            Åu an yÃ¼klÃ¼ bir ÅŸablonunuz yok. Sorun deÄŸil, saÄŸ alttaki <strong>Devam Et</strong> butonu ile ilerleyin.<br><br>
                            Dosya yÃ¼kleme adÄ±mlarÄ±nda yeni ÅŸablon oluÅŸturacak, en sonda ise (AdÄ±m 5) tÃ¼m ayarlarÄ±nÄ±zÄ± <strong>"Yedek DosyasÄ±"</strong> olarak indirip, bir sonraki giriÅŸinizde buraya yÃ¼kleyebileceksiniz.
                        </p>
                    </div>
                </div>
                <div style="text-align:right; margin-top:3rem;"><button onclick="processStep0()" class="primary-btn">Devam Et â†’</button></div>
            </div>

            <div id="step-1" class="wizard-step">
                <h2>Ä°Ã§ Stok (Master Data) YÃ¼kle</h2>
                <div class="info-box">
                    <span>ğŸ“¦</span>
                    <div>
                        <strong>BurasÄ± Sizin Deponuz:</strong> Elinizde fiziksel olarak bulunan Ã¼rÃ¼nlerin listesini (Excel/CSV) buraya yÃ¼kleyin. Bu veri, diÄŸer tÃ¼m verilerden Ã¶nceliklidir.
                    </div>
                </div>

                <form id="step-1-form">
                    <div class="form-group">
                        <label>Stok Ã–ncelik KuralÄ±</label>
                        <span class="form-hint">Bir Ã¼rÃ¼n hem sizde hem tedarikÃ§ide varsa stok nasÄ±l hesaplansÄ±n?</span>
                        <div style="margin-top:10px;">
                            <div class="radio-group">
                                <input type="radio" name="stock_strategy" value="internal" checked>
                                <div class="radio-content">
                                    <label>Sadece Benim StoÄŸum (TedarikÃ§iyi Yoksay)</label>
                                    <span class="text-muted-small">TedarikÃ§ide Ã¼rÃ¼n olsa bile dikkate alÄ±nmaz. Sadece yÃ¼klediÄŸiniz dosyadaki stok adedi pazaryerine gider.</span>
                                </div>
                            </div>
                            <div class="radio-group" style="border-color:#10b981; background:#f0fdf4;">
                                <input type="radio" name="stock_strategy" value="minimum">
                                <div class="radio-content">
                                    <label style="color:#047857;">Minimum DeÄŸer (En Az OlanÄ± Yaz)</label>
                                    <span class="text-muted-small"><strong>Ã–nerilen.</strong> AÅŸÄ±rÄ± satÄ±ÅŸ (overselling) riskini Ã¶nler. (Ã–rn: Sizde 5, TedarikÃ§ide 2 varsa -> YayÄ±na 2 gider.)</span>
                                </div>
                            </div>
                            <div class="radio-group">
                                <input type="radio" name="stock_strategy" value="supplier">
                                <div class="radio-content">
                                    <label>Sadece TedarikÃ§i StoÄŸu</label>
                                    <span class="text-muted-small">Sizin elinizdeki fiziksel stok Ã¶nemsizdir. DoÄŸrudan tedarikÃ§iden gelen veri yansÄ±tÄ±lÄ±r.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="form-group">
                        <label>Veri KaynaÄŸÄ± Tipi</label>
                        <div style="display:flex; gap:20px; margin-top:10px;">
                            <div class="radio-group" style="flex:1">
                                <input type="radio" id="stok-kaynagi-1" name="stock_source" value="single_file" checked onchange="toggleStockSource()">
                                <div class="radio-content">
                                    <label>Tek Dosya (Stok Listesi)</label>
                                    <span class="text-muted-small">TÃ¼m Ã¼rÃ¼nlerin gÃ¼ncel adetlerini iÃ§erir. (SayÄ±m dosyasÄ±)</span>
                                </div>
                            </div>
                            <div class="radio-group" style="flex:1">
                                <input type="radio" id="stok-kaynagi-2" name="stock_source" value="movements" onchange="toggleStockSource()">
                                <div class="radio-content">
                                    <label>Hareket (GiriÅŸ/Ã‡Ä±kÄ±ÅŸ)</label>
                                    <span class="text-muted-small">Sadece stoÄŸu deÄŸiÅŸen Ã¼rÃ¼nleri gÃ¼nceller (+5, -2 vb.)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="source-single-file" class="input-group">
                        <div class="form-group" style="flex:1">
                            <label>Dosya SeÃ§in</label>
                            <div class="dropzone-like" id="dz-single">
                                <div class="dz-icon">ğŸ“„</div>
                                <input type="file" id="single-file-upload" style="display:none;">
                                <span class="dz-like-text">Excel veya CSV SÃ¼rÃ¼kleyin</span>
                                <div id="fn-single" style="color:#0f766e; font-weight:bold; margin-top:5px;"></div>
                            </div>
                        </div>
                        <div class="form-group" style="flex:1">
                            <label>Åablon SeÃ§in</label>
                            <span class="form-hint">Hangi sÃ¼tunun ne olduÄŸunu sisteme tanÄ±tÄ±n.</span>
                            <select id="single-file-template" class="template-dropdown" style="margin-top:5px;"></select>
                            <button type="button" class="secondary-btn" style="width:100%; margin-top:10px; padding:8px;" onclick="openTemplateModal('internal')">+ Yeni Åablon OluÅŸtur</button>
                        </div>
                    </div>
                    
                    <div id="source-movements" style="display:none">
                        <div class="input-group"><div class="form-group" style="flex:1"><label>GiriÅŸler (+)</label><div class="dropzone-like" id="dz-plus"><input type="file" id="movement-file-plus" style="display:none;"><span class="dz-like-text">SeÃ§... <div id="fn-plus"></div></span></div></div><div class="form-group" style="flex:1"><label>Åablon</label><select id="movement-template-plus" class="template-dropdown"></select></div></div>
                        <div class="input-group"><div class="form-group" style="flex:1"><label>Ã‡Ä±kÄ±ÅŸlar (-)</label><div class="dropzone-like" id="dz-minus"><input type="file" id="movement-file-minus" style="display:none;"><span class="dz-like-text">SeÃ§... <div id="fn-minus"></div></span></div></div><div class="form-group" style="flex:1"><label>Åablon</label><select id="movement-template-minus" class="template-dropdown"></select></div></div>
                        <button type="button" class="primary-btn secondary-btn" style="width:100%; padding:10px;" onclick="openTemplateModal('internal')">Hareket Åablonu OluÅŸtur</button>
                    </div>
                    
                    <hr>
                    <div class="form-group">
                        <label>GÃ¼venlik StoÄŸu (Buffer)</label>
                        <span class="form-hint">Stok sayÄ±sÄ± kritik seviyenin altÄ±na dÃ¼ÅŸtÃ¼ÄŸÃ¼nde sanal olarak azaltÄ±r.</span>
                        <div style="display:flex; gap:20px; margin-top:10px;">
                            <div class="radio-group" style="flex:1"><input type="radio" id="sec-stok-1" name="security_stock_type" value="none" checked onchange="toggleSecurityStock()"><label>Pasif</label></div>
                            <div class="radio-group" style="flex:1"><input type="radio" id="sec-stok-2" name="security_stock_type" value="advanced" onchange="toggleSecurityStock()"><label>Aktif</label></div>
                        </div>
                    </div>
                    <div id="security-stock-inputs" class="input-group" style="display:none; background:#F8FAFC; padding:20px; border:1px solid #E2E8F0; border-radius:10px;">
                        <div class="form-group" style="flex:1; margin:0;"><label>Kritik EÅŸik</label><input type="number" id="security-threshold" placeholder="Ã–rn: 5"></div>
                        <div class="form-group" style="flex:1; margin:0;"><label>Gizlenecek Miktar</label><input type="number" id="security-amount" placeholder="Ã–rn: 2"></div>
                    </div>
                    <hr>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <button type="button" onclick="navigateToStep(0)" class="primary-btn secondary-btn">â† Geri</button>
                        <div id="step-1-loader" class="loader"></div>
                        <button type="button" id="step-1-next-btn" onclick="processStep1()" class="primary-btn">Kaydet ve Ä°lerle â†’</button>
                    </div>
                    <p id="step-1-error" class="error-message"></p>
                </form>
            </div>

            <div id="step-2" class="wizard-step">
                <h2>TedarikÃ§i Entegrasyonu</h2>
                <div class="info-box">
                    <span>ğŸ­</span>
                    <div>
                        <strong>SÄ±nÄ±rsÄ±z Kaynak:</strong> XML veya Excel formatÄ±ndaki tÃ¼m tedarikÃ§i dosyalarÄ±nÄ±zÄ± buraya ekleyin. Sistem hepsini tek bir havuzda birleÅŸtirir.
                    </div>
                </div>
                <div id="supplier-file-list"></div>
                <div style="display:flex; gap:20px; margin-top:25px;">
                    <button type="button" id="add-supplier-btn" class="primary-btn secondary-btn" style="flex:1; padding:15px;" onclick="addSup()">+ Dosya Ekle</button>
                    <button type="button" class="primary-btn secondary-btn" style="flex:1; padding:15px;" onclick="openTemplateModal('supplier')">Yeni Åablon OluÅŸtur</button>
                </div>
                <hr>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <button type="button" onclick="navigateToStep(1)" class="primary-btn secondary-btn">â† Geri</button>
                    <div id="step-2-loader" class="loader"></div>
                    <button type="button" id="step-2-next-btn" onclick="processStep2()" class="primary-btn">BirleÅŸtir ve Ä°lerle â†’</button>
                </div>
                <p id="step-2-error" class="error-message"></p>
            </div>

            <div id="step-3" class="wizard-step">
                <h2>Fiyat Motoru ve Kurallar</h2>
                
                <div class="formula-container">
                    <span class="formula-tag ft-cost">Maliyet</span>
                    <span>Ã—</span>
                    <span class="formula-tag ft-mult">Ã‡arpan</span>
                    <span>+</span>
                    <span class="formula-tag ft-add">Ek TL</span>
                    <span>=</span>
                    <span class="formula-tag ft-res">SatÄ±ÅŸ FiyatÄ±</span>
                    <div style="width:100%; text-align:center; font-size:0.8rem; font-weight:normal; margin-top:5px; color:#64748B;">
                        * ÃœrÃ¼n dÃ¶vizli ise, maliyet Ã¶nce TL'ye Ã§evrilir, sonra formÃ¼l uygulanÄ±r.
                    </div>
                </div>

                <div class="form-group" style="background:#F8FAFC; padding:25px; border-radius:12px; border:1px solid #E2E8F0; margin-bottom:30px;">
                    <label style="color:#0F766E; font-size:1rem;">1. Baz Fiyat KaynaÄŸÄ±</label>
                    <span class="form-hint">Hesaplama hangi fiyatÄ±n Ã¼zerine yapÄ±lacak?</span>
                    <select id="price-source-select" style="border-color:#CBD5E1; width:100%; margin-top:10px; padding:12px; font-weight:600;">
                        <option value="calculated">Otomatik (Maliyet + Kar MarjÄ±)</option>
                        <option value="stock_only" style="background:#F0FDFA; color:#0F766E;">Mevcut Pazaryeri FiyatlarÄ±nÄ± Koru</option>
                        <option value="supplier">TedarikÃ§i Liste FiyatÄ±</option>
                        <option value="internal">Ä°Ã§ Stok Liste FiyatÄ±</option>
                    </select>
                </div>

                <div id="section-fallback" style="display:block; margin-bottom:30px;">
                    <label>2. VarsayÄ±lan Kar MarjÄ± (BAÅLANGIÃ‡)</label>
                    <div style="background:#fff; padding:20px; border:1px solid #E2E8F0; border-radius:12px; margin-top:10px;">
                        <span class="form-hint" style="margin-bottom:15px;">Bu oranlar tÃ¼m Ã¼rÃ¼nler iÃ§in <strong>ilk hesaplanan baz fiyatÄ±</strong> oluÅŸturur.</span>
                        <div class="input-group">
                            <div class="form-group" style="flex:1; margin:0;"><label>Ã‡arpan</label><input type="number" id="cost-plus-default-multiplier" placeholder="1.5" value="1.5"></div>
                            <div class="form-group" style="flex:1; margin:0;"><label>Ek (TL)</label><input type="number" id="cost-plus-default-addition" placeholder="0" value="0"></div>
                        </div>
                        <div id="brand-rules-container"></div>
                        <button type="button" id="add-brand-rule-btn" class="primary-btn secondary-btn" style="width:100%; margin-top:15px; font-size:0.9rem;">+ Marka BazlÄ± Kural Ekle</button>
                    </div>
                </div>

                <div class="step-connector">
                    <span>ğŸ‘‡ Bu hesaplamadan sonra ÅŸu kurallar devreye girer ğŸ‘‡</span>
                </div>

                <div id="section-nlp" class="form-group">
                    <label>3. GeliÅŸmiÅŸ Kurallar (DoÄŸal Dil Ä°ÅŸleme)</label>
                    <span class="form-hint">Bu kurallar, yukarÄ±da hesaplanan baz fiyatÄ±n <strong>ÃœZERÄ°NE</strong> uygulanÄ±r veya onu <strong>EZER</strong> (Sabitleme gibi).</span>
                    <div class="nlp-grid" style="margin-top:10px;">
                        <div>
                            <textarea id="nlp-price-rules" rows="8" placeholder="Ã–rn:&#10;TÃœM BOSCH ÃœRÃœNLERÄ°NE %10 ZAM YAP&#10;MAKITA GÃœNCEL KURA EÅÄ°TLE&#10;R18-256 5000 TL OLSUN&#10;ADIDAS ÃœRÃœNLERÄ°NE 50 TL Ä°NDÄ°RÄ°M" style="resize:vertical; font-family:'Consolas', monospace; border:2px solid #E2E8F0; padding:15px; font-size:0.95rem;"></textarea>
                            
                            <div class="sim-container">
                                <h4 style="margin:0 0 10px 0; color:#0F766E;">KurallarÄ± Test Et</h4>
                                <span class="form-hint" style="margin-bottom:10px;">YazdÄ±ÄŸÄ±nÄ±z kurallarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶rmek iÃ§in bir Excel dosyasÄ± yÃ¼kleyin.</span>
                                <div style="display:flex; gap:10px; margin-bottom:10px;">
                                    <select id="sim-template" style="flex:1;" class="template-dropdown"></select>
                                    <button type="button" onclick="document.getElementById('sim-file-upload').click()" class="secondary-btn" style="font-size:0.85rem;">Dosya SeÃ§</button>
                                    <input type="file" id="sim-file-upload" style="display:none;" onchange="document.getElementById('sim-filename').innerText = this.files[0].name">
                                </div>
                                <div id="sim-filename" style="font-size:0.8rem; color:#0F766E; margin-bottom:10px; font-weight:bold;"></div>
                                <button type="button" onclick="runSimulation()" class="primary-btn" style="width:100%;">Testi Ã‡alÄ±ÅŸtÄ±r</button>
                                <div id="sim-results-area" style="margin-top:15px; display:none;">
                                    <table class="sim-table"><thead><tr><th>ÃœrÃ¼n</th><th>Eski</th><th>Yeni</th><th>Kural</th></tr></thead><tbody id="sim-tbody"></tbody></table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="guide-panel">
                            <div class="guide-header">HÄ±zlÄ± Komut KÃ¼tÃ¼phanesi</div>
                            <div class="guide-content">
                                <div class="guide-item" onclick="insertRule('TUM URUNLERE %10 ZAM YAP')">
                                    <span class="badge bg-red">ZAM</span> <strong>Genel ArtÄ±ÅŸ</strong>
                                    <span class="guide-desc">TÃ¼m Ã¼rÃ¼nlere %10 ekler.</span>
                                </div>
                                <div class="guide-item" onclick="insertRule('MAKITA %5 INDIRIM YAP')">
                                    <span class="badge bg-green">Ä°NDÄ°RÄ°M</span> <strong>Marka KampanyasÄ±</strong>
                                    <span class="guide-desc">Belirtilen markanÄ±n fiyatÄ±nÄ± dÃ¼ÅŸÃ¼rÃ¼r.</span>
                                </div>
                                <div class="guide-item" onclick="insertRule('R18-256 %15 ZAM YAP')">
                                    <span class="badge bg-blue">SKU</span> <strong>Tekil ÃœrÃ¼n</strong>
                                    <span class="guide-desc">Ã–zel bir Ã¼rÃ¼n koduna (SKU) zam yapar.</span>
                                </div>
                                <div class="guide-item" onclick="insertRule('BOSCH GUNCEL KURA ESITLE')">
                                    <span class="badge bg-blue">DÃ–VÄ°Z</span> <strong>Endeksleme</strong>
                                    <span class="guide-desc">FiyatÄ± (Liste * GÃ¼ncel Kur) yapar.</span>
                                </div>
                                <div class="guide-item" onclick="insertRule('ESKI_KUR=34.50\nSTANLEY GUNCEL KURA CEVIR')">
                                    <span class="badge bg-blue">Ã‡EVÄ°R</span> <strong>Kur DÃ¶nÃ¼ÅŸÃ¼mÃ¼</strong>
                                    <span class="guide-desc">Maliyeti eski kurdan Ã§Ä±karÄ±p yeni kurla Ã§arpar.</span>
                                </div>
                                <div class="guide-item" onclick="insertRule('GSR-120 4500 TL OLSUN')">
                                    <span class="badge bg-blue">SABÄ°T</span> <strong>Fiyat Sabitleme</strong>
                                    <span class="guide-desc">Maliyetten baÄŸÄ±msÄ±z net etiket basar.</span>
                                </div>
                                <div class="guide-item" onclick="insertRule('TUM FIYATLARIN SONU .99 OLSUN')">
                                    <span class="badge bg-blue">PSÄ°KOLOJÄ°K</span> <strong>KÃ¼sÃ¼rat</strong>
                                    <span class="guide-desc">Ã–rn: 100 TL -> 99.99 TL olur.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="section-vat" class="form-group" style="background:#FFF7ED; padding:20px; border-radius:12px; border:1px solid #FFEDD5; margin-bottom:30px;">
                    <label style="color:#C2410C; font-weight:700;">4. KDV YÃ¶netimi</label>
                    <div class="radio-group" style="margin-top:10px;"><input type="checkbox" id="add-vat-checkbox" onchange="document.getElementById('vat-input-group').style.display=this.checked?'flex':'none'"> <label style="font-weight:500;">En Sona KDV Ekle (+)</label></div>
                    <div id="vat-input-group" style="display:none; gap:10px; margin-top:15px; align-items:center;"><label>Oran (%):</label><input type="number" id="vat-rate" value="20" style="width:80px; padding:10px;"></div>
                </div>
                
                <hr>
                <div class="form-group">
                    <label>Fiyat Koruma (Smart Freeze)</label>
                    <span class="form-hint">Pazaryerindeki mevcut fiyatÄ±nÄ±z, hesaplanan yeni fiyattan yÃ¼ksekse; fiyatÄ± dÃ¼ÅŸÃ¼rmek yerine korur.</span>
                    <div class="radio-group" style="background:#FFFBEB; padding:15px; border-radius:8px; border:1px solid #FCD34D; margin-top:10px;"><input type="checkbox" id="smart-freeze" checked><label><b>AkÄ±llÄ± Dondurma:</b> DÃ¼ÅŸÃ¼ÅŸleri engelle (Sadece zamlarÄ± yansÄ±t).</label></div>
                </div>
                <div class="form-group">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label>Manuel Dondurma Listesi (Opsiyonel)</label>
                        <a href="/api/v1/download_template/freeze" class="primary-btn secondary-btn" style="padding:5px 10px; font-size:0.8rem;">ğŸ“¥ Ã–rnek Åablon</a>
                    </div>
                    <div class="dropzone-like" id="dz-freeze" style="min-height: 80px; padding: 20px; margin-top:10px;">
                        <div class="dz-icon" style="font-size:1.5rem; margin-bottom:5px;">â„ï¸</div>
                        <input type="file" id="freeze-file-upload" style="display:none;">
                        <span class="dz-like-text">Excel DosyasÄ± SeÃ§in</span>
                    </div>
                </div>
                <hr>
                <div style="display:flex; justify-content:space-between;"><button type="button" onclick="navigateToStep(2)" class="primary-btn secondary-btn">â† Geri</button><button type="button" id="step-3-next-btn" onclick="processStep3()" class="primary-btn">Kaydet ve Ä°lerle â†’</button></div><p id="step-3-error" class="error-message"></p>
            </div>

            <div id="step-4" class="wizard-step">
                <h2>SonuÃ§ ve Raporlama</h2>
                
                <div class="disclaimer-box">
                    <span style="font-size:2rem; margin-top:-5px;">âš ï¸</span>
                    <div>
                        <strong>SORUMLULUK REDDÄ° BEYANI</strong>
                        Bu yazÄ±lÄ±m bir karar destek sistemidir. OluÅŸturulan Ã§Ä±ktÄ±larÄ±n nihai kontrolÃ¼ tamamen kullanÄ±cÄ±ya aittir. GeliÅŸtirici, hatalÄ± fiyatlandÄ±rma veya stok eÅŸleÅŸmelerinden kaynaklanabilecek maddi zararlardan sorumlu tutulamaz. <br><br>
                        LÃ¼tfen "Algoritma Skoru" dÃ¼ÅŸÃ¼k olan satÄ±rlarÄ± pazar yerine yÃ¼klemeden Ã¶nce <strong>mutlaka manuel kontrol ediniz.</strong>
                    </div>
                </div>

                <div class="input-group">
                    <div class="form-group" style="flex:1">
                        <label>Hedef Pazar Yeri DosyasÄ±</label>
                        <span class="form-hint">Trendyol veya HB'den indirdiÄŸiniz gÃ¼ncel Ã¼rÃ¼n listesi.</span>
                        <div class="dropzone-like" id="dz-mp" style="margin-top:10px;">
                            <div class="dz-icon">ğŸ›’</div>
                            <input type="file" id="marketplace-file-upload" style="display:none;">
                            <span class="dz-like-text">DosyayÄ± Buraya BÄ±rakÄ±n</span>
                            <div id="fn-mp" style="color:#0f766e; font-weight:bold; margin-top:5px;"></div>
                        </div>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Åablon SeÃ§in</label>
                        <select id="marketplace-template" class="template-dropdown" style="margin-top:10px;"></select>
                        <button type="button" class="secondary-btn" style="width:100%; margin-top:10px; padding:10px;" onclick="openTemplateModal('marketplace')">+ Pazar Yeri Åablonu OluÅŸtur</button>
                    </div>
                </div>
                
                <div style="margin-top:30px; padding:25px; background:#F8FAFC; border:2px solid #E2E8F0; border-radius:12px;">
                    <label style="font-size:1.1rem; border-bottom:2px solid #E2E8F0; padding-bottom:10px; display:block; margin-bottom:15px; font-weight:700;">Analiz AyarlarÄ±</label>
                    <div class="form-group" style="margin-bottom:15px;"><div class="radio-group"><input type="checkbox" id="brand-extraction-strategy" value="extract_from_name" checked><label>Derin Tarama (ÃœrÃ¼n isminden marka bulma)</label></div></div>
                    <div class="form-group" style="margin-bottom:15px;"><div class="radio-group"><input type="checkbox" id="include-original-format" value="true" checked><label>Orijinal FormatÄ± Koru (YÃ¼klemeye HazÄ±r Ã‡Ä±ktÄ±)</label></div></div>
                    <div class="form-group" style="margin:0;"><div class="radio-group"><input type="checkbox" id="download-templates-with-report" checked><label>Åablon AyarlarÄ±nÄ± Yedekle (Ã–nerilen)</label></div></div>
                </div>
                
                <div id="progress-container" class="progress-container">
                    <div class="progress-bar-bg"><div id="progress-bar-fill" class="progress-bar-fill"></div></div>
                    <p id="progress-text" class="progress-text">Ä°ÅŸlem BaÅŸlatÄ±lÄ±yor...</p>
                </div>
                
                <hr>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <button type="button" onclick="navigateToStep(3)" class="primary-btn secondary-btn">â† Geri</button>
                    <button type="button" id="step-4-run-btn" onclick="processStep4()" class="primary-btn" style="background:#0F766E; padding:18px 40px; font-size:1.1rem; box-shadow: 0 4px 10px rgba(15, 118, 110, 0.3);">ANALÄ°ZÄ° BAÅLAT</button>
                </div>
                <p id="step-4-error" class="error-message"></p>
                <div id="report-download-container" class="success-message" style="display:none"></div>
                <button type="button" onclick="location.reload()" class="primary-btn secondary-btn hidden" id="start-over-btn" style="width:100%; margin-top:25px; padding:18px;">Yeni Ä°ÅŸlem BaÅŸlat</button>
            </div>
        </div>
    </div>

    <div class="info-section">
        <h2 style="font-size:2.2rem; border:none; margin-bottom:40px; text-align:center; color:#1E293B;">NasÄ±l KullanÄ±lÄ±r?</h2>
        <button class="accordion-btn">AdÄ±m 1: Veri YÃ¼kleme ve Standardizasyon</button>
        <div class="panel"><p>FarklÄ± kaynaklardan (XML, Excel, CSV) gelen verileri sisteme yÃ¼kleyin. "Åablon OluÅŸtur" diyerek, dosyanÄ±zdaki sÃ¼tunlarÄ±n (Ã–rn: "Stok_Adedi") sistemdeki karÅŸÄ±lÄ±ÄŸÄ±nÄ± (Ã–rn: "Stok") bir kez tanÄ±tÄ±n.</p></div>
        <button class="accordion-btn">AdÄ±m 2: AkÄ±llÄ± EÅŸleÅŸtirme (Smart Matching)</button>
        <div class="panel"><p>StokÃ§u, Ã¼rÃ¼nleri sadece isme gÃ¶re deÄŸil, Ã¼rÃ¼nÃ¼n "Model Kodu"na, markasÄ±na ve Ã¶zelliklerine gÃ¶re analiz eder. YazÄ±m hatalarÄ±nÄ± ve farklÄ± isimlendirmeleri otomatik algÄ±lar.</p></div>
        <button class="accordion-btn">AdÄ±m 3: Dinamik Fiyat Motoru</button>
        <div class="panel"><p>Maliyet Ã¼zerine kar marjÄ± ekleyebilir veya NLP ile "TÃ¼m Bosch Ã¼rÃ¼nlerine %10 zam yap" gibi komutlar verebilirsiniz. DÃ¶viz kurlarÄ± TCMB'den otomatik Ã§ekilir.</p></div>
        <button class="accordion-btn">AdÄ±m 4: Raporlama ve Karar Destek</button>
        <div class="panel"><p>Ä°ÅŸlem tamamlandÄ±ÄŸÄ±nda sistem size detaylÄ± bir Excel raporu sunar. YeÅŸil (GÃ¼venli EÅŸleÅŸme) ve KÄ±rmÄ±zÄ± (EÅŸleÅŸmeyen) sekmelerini inceleyerek pazar yerine yÃ¼kleme yapabilirsiniz.</p></div>
    </div>

    <footer class="site-footer">
        <div class="footer-content">
            <div class="branding-text">
                <span class="brand" style="color:#F1F5F9; font-size:1.5rem; font-weight:800;">StokÃ§u</span>
                <span style="display:block; font-size:0.9rem; color:#94A3B8; margin-top:5px;">Open Source Software</span>
            </div>
            <div class="footer-links">
                GeliÅŸtirici: <a href="https://github.com/AhmetKorkmazMe" target="_blank">Ahmet Korkmaz</a>
                <span style="margin:0 15px; color:#475569;">|</span>
                <a href="/documentation" target="_blank">Teknik DokÃ¼mantasyon</a>
            </div>
        </div>
    </footer>

    <div id="template-modal" class="modal"><div class="modal-content"><h2 id="modal-title" style="border:none;margin-bottom:20px;">Yeni Åablon TanÄ±mla</h2><p id="modal-error" class="error-message"></p><div class="form-group"><label>Åablon AdÄ±</label><input type="text" id="modal-template-name" placeholder="Ã–rn: trendyol_xml_v1"></div><div class="form-group"><label>Ã–rnek Dosya YÃ¼kle</label><span class="form-hint">SÃ¼tun isimlerini okumamÄ±z iÃ§in bu formattaki herhangi bir dosyayÄ± yÃ¼kleyin.</span><div class="dropzone-like" id="dz-sample" style="min-height:100px; padding:20px; margin-top:10px;"><input type="file" id="modal-sample-file" style="display:none;"><span class="dz-like-text">Dosya SeÃ§ <div id="fn-sample" style="font-weight:normal; font-size:1rem; margin-top:5px;"></div></span></div></div><button type="button" id="modal-scan-btn" onclick="scanTemplateFile()" class="primary-btn" style="width:100%; margin-top:15px">DosyayÄ± Tara ve EÅŸleÅŸtir</button><div id="modal-loader" class="loader" style="margin-top:15px;"></div><div id="mapping-area" style="display:none; margin-top:30px;"><hr><h3>SÃ¼tunlarÄ± EÅŸleÅŸtir</h3><span class="form-hint">Sol taraftaki sistem alanlarÄ± ile saÄŸ taraftaki dosya sÃ¼tunlarÄ±nÄ± eÅŸleÅŸtirin.</span><div id="mapping-fields" style="margin-top:15px;"></div></div><hr><div style="display:flex; justify-content:space-between;"><button type="button" onclick="closeTemplateModal()" class="primary-btn secondary-btn">Ä°ptal</button><button type="button" id="modal-save-btn" onclick="saveTemplate()" class="primary-btn hidden">Kaydet</button></div></div></div>

    <script>
        const W={s0:{},s1:{},s2:{},s3:{},s4:{},exc:{},tpl:[]}; let supRow=0, curTpl='internal';
        
        const T_FLDS={
            'internal':[{id:'sku',label:'SKU (Stok Kodu)',required:true},{id:'stock',label:'Stok Adedi',required:true},{id:'selling_price',label:'SatÄ±ÅŸ FiyatÄ±'},{id:'barcode',label:'Barkod (EAN)'},{id:'brand',label:'Marka'},{id:'product_name',label:'ÃœrÃ¼n AdÄ±'}],
            'supplier':[{id:'sku',label:'SKU (Stok Kodu)',required:true},{id:'stock',label:'Stok Adedi',required:true},{id:'barcode',label:'Barkod (EAN)'},{id:'cost',label:'AlÄ±ÅŸ Maliyeti'},{id:'selling_price',label:'Liste SatÄ±ÅŸ FiyatÄ±'},{id:'brand',label:'Marka'},{id:'product_name',label:'ÃœrÃ¼n AdÄ±'},{id:'currency',label:'Sabit Kur (Varsa)',type:'c_static'},{id:'currency_column',label:'Kur SÃ¼tunu (Varsa)',type:'col'}],
            'marketplace':[{id:'sku',label:'SKU (Stok Kodu)',required:true},{id:'barcode',label:'Barkod'},{id:'stock_to_update',label:'GÃ¼ncel Pazar Yeri StoÄŸu',required:true},{id:'current_price',label:'GÃ¼ncel SatÄ±ÅŸ FiyatÄ±',required:true},{id:'product_name',label:'ÃœrÃ¼n AdÄ±',required:true},{id:'brand',label:'Marka'},{id:'description',label:'AÃ§Ä±klama'}]
        };
        const P_ALS={sku:['sku','kod','code','model','stok kodu'],stock:['stok','adet','qty','miktar','quantity'],barcode:['barkod','ean','barcode'],cost:['maliyet','fiyat','cost','alis','alÄ±ÅŸ'],selling_price:['satis','fiyat','price','liste','satÄ±ÅŸ','perakende'],brand:['marka','brand','Ã¼retici'],current_price:['satis','fiyat','price','liste','satÄ±ÅŸ'],product_name:['ad','isim','baslik','title','Ã¼rÃ¼n adÄ±','name','aÃ§Ä±klama','aciklama','description'],description:['aciklama','detay','desc','description']};

        document.addEventListener("DOMContentLoaded",()=>{
            init();
            setupDropzone("dz-single","single-file-upload","fn-single");setupDropzone("dz-plus","movement-file-plus","fn-plus");setupDropzone("dz-minus","movement-file-minus","fn-minus");setupDropzone("dz-freeze","freeze-file-upload","fn-freeze");setupDropzone("dz-mp","marketplace-file-upload","fn-mp");setupDropzone("dz-sample","modal-sample-file","fn-sample");addSup();
            
            const acc = document.getElementsByClassName("accordion-btn");
            for (let i = 0; i < acc.length; i++) {
                acc[i].addEventListener("click", function() { this.classList.toggle("active"); const panel = this.nextElementSibling; if (panel.style.maxHeight) { panel.style.maxHeight = null; panel.classList.remove("show"); } else { panel.classList.add("show"); panel.style.maxHeight = panel.scrollHeight + "px"; } });
            }

            document.getElementById("price-source-select").addEventListener("change", (e) => {
                const val = e.target.value;
                const sf = document.getElementById("smart-freeze");
                const fbSec = document.getElementById("section-fallback");
                fbSec.style.display = (val === 'calculated') ? 'block' : 'none';
                if(val === 'calculated') sf.checked = true;
            });
            document.getElementById("price-source-select").dispatchEvent(new Event('change'));
        });

        function setupDropzone(did,iid,fid){const d=document.getElementById(did),i=document.getElementById(iid),f=document.getElementById(fid);if(!d||!i||!f)return;d.onclick=(e)=>{if(e.target!==i&&e.target.className!=='del-file')i.click();};d.ondragover=e=>{e.preventDefault();d.classList.add('dragover');};d.ondragleave=()=>d.classList.remove('dragover');d.ondrop=e=>{e.preventDefault();d.classList.remove('dragover');if(e.dataTransfer.files.length){i.files=e.dataTransfer.files;updFile(i,f);}};i.onchange=()=>updFile(i,f);}
        function updFile(i,f){if(i.files[0]){f.innerHTML=`${i.files[0].name} <span class="del-file" style="color:#b91c1c;cursor:pointer;margin-left:8px;font-weight:bold;">(SÄ°L)</span>`;f.querySelector('.del-file').onclick=(e)=>{e.stopPropagation();i.value='';f.innerHTML='';};}else f.innerHTML='';}
        
        async function api(u,o={}){
            if(o.body&&!(o.body instanceof FormData))o.headers={'Content-Type':'application/json'};
            try {
                const res = await fetch(u,o);
                if (!res.ok) {
                    let errMsg = `Sunucu HatasÄ±: ${res.status}`;
                    try { const errJson = await res.json(); if(errJson.hata || errJson.error) errMsg = errJson.hata || errJson.error; } catch(e) {}
                    throw new Error(errMsg);
                }
                return res;
            } catch(err) { console.error(err); throw err; }
        }
        
        async function init(){
            try { await api('/api/v1/templates/reset', {method:'POST'}); } catch(e){}
            await loadTpls(); await loadRates();
            document.getElementById("refresh-rates-btn").onclick=async()=>{document.getElementById("rates-loader").style.display="block";await api('/api/v1/exchange-rates/refresh',{method:'POST'});await loadRates();document.getElementById("rates-loader").style.display="none";};
            document.getElementById("add-brand-rule-btn").onclick=()=>document.getElementById("brand-rules-container").insertAdjacentHTML('beforeend',`<div style="display:flex;gap:10px;margin-bottom:10px;"><input class="br-name" placeholder="Marka"><input type="number" class="br-mult" placeholder="Ã‡arpan"><input type="number" class="br-add" placeholder="Ek"><button class="danger-btn" onclick="this.parentElement.remove()" style="padding:0 15px;">Ã—</button></div>`);
        }
        
        async function loadRates(){try{const r=await(await api('/api/v1/exchange-rates')).json();const d=document.getElementById("exchange-rates-display");if(r.rates){W.exc=r.rates;d.innerHTML=`<p style="background:#F0FDFA; padding:12px 15px; border-radius:8px; border:1px solid #CCFBF1; font-size:0.95rem; color:#0F766E;">USD: <b>${r.rates.USD}</b> | EUR: <b>${r.rates.EUR}</b> <span style="float:right; font-size:0.8rem; color:#134E4A; font-weight:600;">${r.last_update}</span></p>`;}else d.innerHTML="Kur alÄ±namadÄ±";}catch(e){document.getElementById("exchange-rates-display").innerHTML="Hata";}}
        async function loadTpls(){try{const r=await(await api('/api/v1/templates')).json();W.tpl=r.templates||[];document.querySelectorAll(".template-dropdown").forEach(s=>{const v=s.value;s.innerHTML='<option value="">SeÃ§...</option>';W.tpl.forEach(t=>s.add(new Option(t,t)));s.value=v;});const l=document.getElementById("template-management-list");l.innerHTML='';if(W.tpl.length===0)l.innerHTML='<p style="color:#64748B; font-size:0.9rem; background:#F1F5F9; padding:15px; border-radius:8px; border:1px dashed #CBD5E1; width:100%;">â„¹ï¸ <strong>Ä°lk kez mi kullanÄ±yorsunuz?</strong><br>Åu an yÃ¼klÃ¼ bir ÅŸablonunuz yok. Sorun deÄŸil, saÄŸ alttaki <strong>Devam Et</strong> butonu ile ilerleyin.<br><br>Dosya yÃ¼kleme adÄ±mlarÄ±nda yeni ÅŸablon oluÅŸturacak, en sonda ise (AdÄ±m 5) tÃ¼m ayarlarÄ±nÄ±zÄ± <strong>"Yedek DosyasÄ±"</strong> olarak indirip, bir sonraki giriÅŸinizde buraya yÃ¼kleyebileceksiniz.</p>';W.tpl.forEach(t=>l.insertAdjacentHTML('beforeend',`<div style="background:#F1F5F9;padding:6px 12px;border-radius:6px;font-size:0.9rem;border:1px solid #CBD5E1; display:flex; align-items:center;">${t} <span onclick="if(confirm('Bu ÅŸablonu silmek istediÄŸinize emin misiniz?'))api('/api/v1/templates/${t}',{method:'DELETE'}).then(loadTpls)" style="color:#EF4444;cursor:pointer;margin-left:8px; font-weight:bold;">Ã—</span></div>`));}catch(e){}}
        
        function insertRule(txt){ const el = document.getElementById("nlp-price-rules"); el.value += (el.value ? "\n" : "") + txt; }
        
        function navigateToStep(n){ document.querySelectorAll(".wizard-step").forEach((s,i)=>s.style.display=i===n?'block':'none'); document.querySelectorAll("#wizard-nav button").forEach((b,i)=>{b.className=i===n?'active':'';b.disabled=i>n;}); window.scrollTo(0,0); }
        function toggleStockSource(){const s=document.getElementById("stok-kaynagi-1").checked;document.getElementById("source-single-file").style.display=s?'flex':'none';document.getElementById("source-movements").style.display=s?'none':'block';}
        function toggleSecurityStock(){document.getElementById("security-stock-inputs").style.display=document.getElementById("sec-stok-2").checked?'flex':'none';}
        function err(n,m){const e=document.getElementById(`step-${n}-error`);e.innerText=m;e.style.display=m?'block':'none';}
        function processStep0(){W.s0.orphan=document.getElementById("orphan-strategy-select").value;navigateToStep(1);}
        
        async function processStep1(){
            const l=document.getElementById("step-1-loader"),b=document.getElementById("step-1-next-btn");l.style.display="block";b.disabled=true;err(1,"");
            try{
                const fd=new FormData();
                fd.append('stock_strategy',document.querySelector('input[name="stock_strategy"]:checked').value);
                if(document.getElementById("sec-stok-2").checked){fd.append('security_threshold',document.getElementById("security-threshold").value);fd.append('security_amount',document.getElementById("security-amount").value);}
                const files=[],tpls=[],labels=[];
                if(document.getElementById("stok-kaynagi-1").checked){
                    const f=document.getElementById("single-file-upload").files[0];
                    if(f){files.push(f);tpls.push(document.getElementById("single-file-template").value);labels.push("+");}
                }else{
                    const fp=document.getElementById("movement-file-plus").files[0]; if(fp){files.push(fp);tpls.push(document.getElementById("movement-template-plus").value);labels.push("+");}
                    const fm=document.getElementById("movement-file-minus").files[0]; if(fm){files.push(fm);tpls.push(document.getElementById("movement-template-minus").value);labels.push("-");}
                }
                if(files.length===0)throw new Error("LÃ¼tfen bir dosya yÃ¼kleyin.");
                if(tpls.some(t=>!t))throw new Error("LÃ¼tfen bir ÅŸablon seÃ§in veya oluÅŸturun.");
                files.forEach(f=>fd.append('files',f));fd.append('template_names',tpls.join(','));fd.append('labels',labels.join(','));
                const r=await(await api('/api/v1/calculate_stock',{method:'POST',body:fd})).json();
                W.s1.key=r.result_key;W.s1.strat=fd.get('stock_strategy');
                navigateToStep(2);
            }catch(e){err(1,e.message);}finally{l.style.display="none";b.disabled=false;}
        }

        function addSup(){supRow++;const d=document.createElement("div");d.className="input-group";d.innerHTML=`<div class="form-group" style="flex:1"><div class="dropzone-like" id="dz-sup-${supRow}" style="min-height:80px; padding:15px;"><div class="dz-icon" style="color:#cbd5e1; font-size:1.5rem;">+</div><input type="file" class="sup-file" id="inp-sup-${supRow}" style="display:none"><span class="dz-like-text" style="font-size:0.9rem;">Dosya SeÃ§ <div id="fn-sup-${supRow}"></div></span></div></div><div class="form-group" style="flex:1"><select class="template-dropdown sup-tpl" style="height:100%;"></select></div><button onclick="this.parentElement.remove()" class="danger-btn" style="height:50px; width:50px; margin-top:auto;">Ã—</button>`;document.getElementById("supplier-file-list").appendChild(d);setupDropzone(`dz-sup-${supRow}`,`inp-sup-${supRow}`,`fn-sup-${supRow}`);const opts=document.getElementById("single-file-template").innerHTML;d.querySelector(".sup-tpl").innerHTML=opts;}
        
        async function processStep2(){
            const l=document.getElementById("step-2-loader"),b=document.getElementById("step-2-next-btn");l.style.display="block";b.disabled=true;err(2,"");
            try{
                const fd=new FormData(),files=[],tpls=[];
                document.querySelectorAll("#supplier-file-list .input-group").forEach(r=>{
                    const f=r.querySelector(".sup-file").files[0],t=r.querySelector(".sup-tpl").value;
                    if(f&&t){files.push(f);tpls.push(t);}
                });
                if(files.length){files.forEach(f=>fd.append('files',f));fd.append('template_names',tpls.join(','));const r=await(await api('/api/v1/consolidate_suppliers',{method:'POST',body:fd})).json();W.s2.key=r.result_key;}
                navigateToStep(3);
            }catch(e){err(2,e.message);}finally{l.style.display="none";b.disabled=false;}
        }
        
        async function processStep3(){
            err(3,"");
            try{
                const sourceVal = document.getElementById("price-source-select").value;
                let ps = null;
                if(sourceVal === 'calculated'){
                    ps = { type: 'cost_plus_brand', default_multiplier: document.getElementById("cost-plus-default-multiplier").value, default_addition: document.getElementById("cost-plus-default-addition").value, brand_rules: [] };
                    document.querySelectorAll("#brand-rules-container div").forEach(r => { ps.brand_rules.push({ brand: r.querySelector(".br-name").value, multiplier: r.querySelector(".br-mult").value, addition: r.querySelector(".br-add").value }); });
                } else { ps = { type: 'ready_list' }; }

                let fr = { skus: [], barcodes: [] };
                const ff=document.getElementById("freeze-file-upload").files[0];
                if(ff){
                    const d=await(new Response(ff)).arrayBuffer();
                    const w=XLSX.read(d);
                    const j=XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]);
                    j.forEach(r=>{
                        const sku=r.SKU||r.sku||r.Sku; const barkod=r.BARKOD||r.barkod||r.Barkod;
                        if(sku)fr.skus.push(String(sku)); if(barkod)fr.barcodes.push(String(barkod));
                    });
                }
                W.s3={price:ps,freeze:fr,smart:document.getElementById("smart-freeze").checked};
                navigateToStep(4);
            }catch(e){ console.error(e); err(3,e.message); }
        }
        
        async function runSimulation(){
            const file = document.getElementById("sim-file-upload").files[0];
            const rules = document.getElementById("nlp-price-rules").value;
            const tpl = document.getElementById("sim-template").value;
            if(!file) return alert("LÃ¼tfen test iÃ§in bir Excel dosyasÄ± seÃ§in.");
            if(!tpl) return alert("LÃ¼tfen test iÃ§in bir ÅŸablon seÃ§in.");
            
            const fd = new FormData();
            fd.append("file", file);
            fd.append("rules", rules);
            fd.append("template_name", tpl);
            
            try {
                const res = await api('/api/v1/simulate_nlp', {method:'POST', body:fd});
                const data = await res.json();
                const tbody = document.getElementById("sim-tbody");
                tbody.innerHTML = "";
                if(data.preview && data.preview.length > 0){
                    data.preview.forEach(row => {
                        tbody.innerHTML += `<tr><td>${row.urun}</td><td>${row.eski}</td><td style="font-weight:bold;color:#0f766e;">${row.yeni}</td><td>${row.kurallar}</td></tr>`;
                    });
                    document.getElementById("sim-results-area").style.display = "block";
                } else {
                    alert("EÅŸleÅŸme bulunamadÄ± veya kurallar uygulanmadÄ±.");
                }
            } catch(e) {
                alert("SimÃ¼lasyon HatasÄ±: " + e.message);
            }
        }
        
        async function processStep4(){
            const runBtn = document.getElementById("step-4-run-btn");
            const progressContainer = document.getElementById("progress-container");
            const progressBar = document.getElementById("progress-bar-fill");
            const progressText = document.getElementById("progress-text");
            const downloadContainer = document.getElementById("report-download-container");
            const errorContainer = document.getElementById("step-4-error");

            runBtn.disabled = true;
            downloadContainer.style.display = "none";
            errorContainer.style.display = "none";
            progressContainer.style.display = "block";
            progressBar.style.width = "5%";
            progressText.innerText = "BaÅŸlatÄ±lÄ±yor...";

            try {
                const fd=new FormData();
                fd.append('internal_stock_key',W.s1.key);
                if(W.s2.key)fd.append('supplier_stock_key',W.s2.key);
                fd.append('stock_strategy',W.s1.strat);
                fd.append('price_strategy_json',JSON.stringify(W.s3.price));
                fd.append('freeze_config_json',JSON.stringify(W.s3.freeze));
                fd.append('smart_freeze',W.s3.smart);
                fd.append('orphan_strategy',W.s0.orphan);
                
                fd.append('price_rules_text', document.getElementById("nlp-price-rules").value);
                fd.append('price_source_selection', document.getElementById("price-source-select").value);
                fd.append('add_vat', document.getElementById("add-vat-checkbox").checked ? 'true' : 'false');
                fd.append('vat_rate', document.getElementById("vat-rate").value);
                
                const mp=document.getElementById("marketplace-file-upload").files[0];
                if(!mp)throw new Error("LÃ¼tfen bir Pazar Yeri dosyasÄ± yÃ¼kleyin.");
                fd.append('marketplace_file',mp);
                fd.append('template_name',document.getElementById("marketplace-template").value);
                if(document.getElementById("brand-extraction-strategy").checked)fd.append('brand_extraction_strategy','extract_from_name');
                if(document.getElementById("include-original-format").checked)fd.append('include_original_format','true');
                if(document.getElementById("download-templates-with-report").checked)fd.append('download_templates','true');
                
                const r = await api('/api/v1/process_marketplace', {method:'POST', body:fd});
                const { job_id } = await r.json();
                pollJob(job_id);

            } catch(e) {
                errorContainer.style.display = "block";
                errorContainer.innerText = e.message;
                runBtn.disabled = false;
                progressContainer.style.display = "none";
            }
        }

        async function pollJob(jobId) {
            try {
                const res = await api(`/api/v1/jobs/${jobId}`);
                const status = await res.json();
                
                const progressBar = document.getElementById("progress-bar-fill");
                const progressText = document.getElementById("progress-text");
                progressBar.style.width = status.progress + "%";
                progressText.innerText = status.message;

                if (status.status === "completed") {
                    window.location.href = `/api/v1/download/${jobId}`;
                    if(document.getElementById('download-templates-with-report').checked) await exportTemplates();
                    document.getElementById("report-download-container").style.display="block";
                    // EMOJÄ° KALDIRILDI
                    document.getElementById("report-download-container").innerText = "Ä°ÅŸlem BaÅŸarÄ±yla TamamlandÄ±. Rapor Ä°ndirildi.";
                    document.getElementById("start-over-btn").classList.remove("hidden");
                    document.getElementById("step-4-run-btn").disabled = false;
                } 
                else if (status.status === "error") { throw new Error(status.error); } 
                else { setTimeout(() => pollJob(jobId), 1000); }

            } catch(e) {
                document.getElementById("step-4-error").style.display = "block";
                document.getElementById("step-4-error").innerText = "Hata: " + e.message;
                document.getElementById("step-4-run-btn").disabled = false;
                document.getElementById("progress-container").style.display = "none";
            }
        }
        
        function openTemplateModal(t){
            curTpl=t;
            document.getElementById("modal-template-name").value = "";
            document.getElementById("modal-sample-file").value = ""; 
            document.getElementById("fn-sample").innerText = ""; 
            document.getElementById("mapping-fields").innerHTML = ""; 
            document.getElementById("mapping-area").style.display = "none";
            document.getElementById("modal-save-btn").classList.add("hidden");
            document.getElementById("modal-error").style.display = "none";
            document.getElementById("template-modal").style.display="flex";
        }
        function closeTemplateModal(){document.getElementById("template-modal").style.display="none";}
        async function scanTemplateFile(){const f=document.getElementById("modal-sample-file").files[0];if(!f)return alert("Dosya seÃ§");document.getElementById("modal-loader").style.display="block";const d=await(new Response(f)).arrayBuffer();const w=XLSX.read(d);const h=XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]],{header:1})[0];document.getElementById("modal-loader").style.display="none";const m=document.getElementById("mapping-fields");m.innerHTML='';T_FLDS[curTpl].forEach(tf=>{let sel=`<select id="map-${tf.id}"><option value="">SeÃ§...</option>`;if(tf.type==='c_static')sel=`<select id="map-${tf.id}"><option value="">Yok</option><option value="TRY">TRY</option><option value="USD">USD</option><option value="EUR">EUR</option></select>`;else h.forEach(x=>sel+=`<option value="${x}">${x}</option>`);m.innerHTML+=`<div><label>${tf.label} ${tf.required?'*':''}</label>${sel}</div>`;if(tf.type!=='c_static'){const found=h.find(hh=>P_ALS[tf.id]?.includes(String(hh).toLowerCase().trim()));if(found)setTimeout(()=>document.getElementById(`map-${tf.id}`).value=found,100);}});document.getElementById("mapping-area").style.display="block";document.getElementById("modal-save-btn").classList.remove("hidden");}
        async function saveTemplate(){const c={};T_FLDS[curTpl].forEach(tf=>{const v=document.getElementById(`map-${tf.id}`).value;if(v)c[tf.id]=v;});await api('/api/v1/templates',{method:'POST',body:JSON.stringify({template_name:document.getElementById("modal-template-name").value,config:c})});closeTemplateModal();loadTpls();}
        function importTemplates(){document.getElementById("template-import-file").click();}
        
        async function handleTemplateImport(e){
            const f=e.target.files[0]; if(!f)return;
            try {
                const t=JSON.parse(await f.text());
                const r = await api('/api/v1/templates/import_all', {method:'POST', body: JSON.stringify(t)});
                loadTpls();
                alert((await r.json()).mesaj || "YÃ¼klendi");
            } catch(err) { alert("Dosya formatÄ± hatalÄ±: " + err); }
        }
        
        async function exportTemplates(){
            const r = await(await api('/api/v1/templates/export_all')).json();
            const b=new Blob([JSON.stringify(r)],{type:'application/json'});
            const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="stokcu_yedek.json"; a.click();
        }
    </script>
</body>
</html>
